<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kaptanın Spotify</title>

<style>

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: Arial, sans-serif;
}

body {
  background: #000;
  color: white;
  display: flex;
  height: 100vh;
  overflow: hidden;
}

/* ------------------------- */
/*        SIDEBAR            */
/* ------------------------- */

.sidebar {
  width: 240px;
  background: #000;
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 25px;
  border-right: 1px solid #111;
}

.sidebar h1 {
  font-size: 24px;
  font-weight: bold;
  color: #1DB954;
}

.sidebar a {
  color: #ddd;
  text-decoration: none;
  font-size: 16px;
  padding: 8px 0;
  transition: .2s;
}

.sidebar a:hover {
  color: white;
}

/* ------------------------- */
/*     MAIN CONTENT          */
/* ------------------------- */

.main {
  flex: 1;
  display: flex;
  flex-direction: column;
  background: linear-gradient(180deg, #222 0%, #000 40%);
  overflow: hidden;
}

.header {
  padding: 20px;
  font-size: 26px;
  font-weight: bold;
}

.search-box {
  margin: 0 20px;
}

.search-box input {
  width: 100%;
  padding: 14px;
  border-radius: 8px;
  background: #111;
  border: 1px solid #333;
  color: white;
  font-size: 16px;
}

/* ------------------------- */
/*       SEARCH RESULTS      */
/* ------------------------- */

.results {
  margin-top: 20px;
  padding: 0 20px;
  height: 260px;
  overflow-y: auto;
}

.result-item {
  display: flex;
  align-items: center;
  gap: 15px;
  padding: 12px;
  border-radius: 8px;
  margin-bottom: 8px;
  cursor: pointer;
  transition: .2s;
  background: #111;
}

.result-item:hover {
  background: #181818;
}

.result-item img {
  width: 65px;
  height: 65px;
  border-radius: 6px;
}

.result-title {
  font-size: 17px;
  font-weight: bold;
}

/* ------------------------- */
/*       PLAYLIST AREA       */
/* ------------------------- */

.playlist {
  padding: 20px;
  flex: 1;
  overflow-y: auto;
}

.playlist h2 {
  margin-bottom: 12px;
  font-size: 22px;
}

.song-item {
  background: #111;
  padding: 12px;
  border-radius: 8px;
  display: flex;
  gap: 15px;
  align-items: center;
  margin-bottom: 10px;
  cursor: pointer;
  transition: .2s;
}

.song-item:hover {
  background: #181818;
}

.song-item img {
  width: 60px;
  height: 60px;
  border-radius: 6px;
}

.song-info {
  display: flex;
  flex-direction: column;
}

.song-info .title {
  font-size: 16px;
  font-weight: bold;
}

.song-info .author {
  font-size: 14px;
  opacity: .7;
}

/* ------------------------- */
/*        PLAYER BAR         */
/* ------------------------- */

.player-bar {
  height: 110px;
  background: #111;
  border-top: 1px solid #222;
  display: flex;
  align-items: center;
  padding: 15px;
  gap: 20px;
}

.player-thumb {
  width: 75px;
  height: 75px;
  border-radius: 6px;
  background: #222;
}

.player-info {
  flex: 1;
}

.player-info .title {
  font-size: 18px;
  font-weight: bold;
}

.player-info .author {
  font-size: 14px;
  opacity: .7;
}

.controls {
  display: flex;
  gap: 20px;
}

.controls button {
  background: none;
  border: none;
  color: white;
  font-size: 28px;
  cursor: pointer;
}

.controls button:hover {
  color: #1DB954;
}

/* ------------------------- */
/* EMBED (GİZLİ PLAYER)      */
/* ------------------------- */

#yt-player {
  width: 0;
  height: 0;
  visibility: hidden;
}

/* ------------------------- */
/* SCROLL BAR                */
/* ------------------------- */

::-webkit-scrollbar {
  width: 6px;
}

::-webkit-scrollbar-thumb {
  background: #444;
  border-radius: 10px;
}

</style>
</head>
<body>

<!-- ----------------------------- -->
<!--          SIDEBAR              -->
<!-- ----------------------------- -->

<div class="sidebar">
  <h1>Kaptanify</h1>
  <a href="#">Ana Sayfa</a>
  <a href="#">Keşfet</a>
  <a href="#">Listem</a>
  <a href="#">Ayarlar</a>
</div>

<!-- ----------------------------- -->
<!--           MAIN                -->
<!-- ----------------------------- -->

<div class="main">

  <div class="header">Müzik Keşfet</div>

  <div class="search-box">
    <input id="searchInput" type="text" placeholder="Şarkı veya sanatçı ara…">
  </div>

  <div class="results" id="results"></div>

  <div class="playlist">
    <h2>Çalma Listem</h2>
    <div id="playlist"></div>
  </div>

</div>

<!-- ----------------------------- -->
<!--         PLAYER BAR            -->
<!-- ----------------------------- -->

<div class="player-bar">
  <img id="playerThumb" class="player-thumb" src="">
  <div class="player-info">
    <div class="title" id="playerTitle">Şarkı Seçilmedi</div>
    <div class="author" id="playerAuthor"></div>
  </div>

  <div class="controls">
    <button id="prevBtn">⏮</button>
    <button id="playBtn">▶</button>
    <button id="nextBtn">⏭</button>
  </div>
</div>

<!-- GİZLİ PLAYER -->
<iframe id="yt-player" src=""></iframe>

<!-- JS BURAYA GELECEK (PART 2) -->

</body>
</html>
<script>
/* ============================
   PART 2 - YOUTUBE + PLAYER
   ============================
*/

/* -------- CONFIG ---------- */
const API_KEY = "AIzaSyAFmms_JJrVmmv-rPP4INamToX9xmuVyJY";
const MAX_RESULTS = 20;
const PREVIEW_SECONDS = 7;
const PREVIEW_MIN_START = 5;
const PREVIEW_MAX_START = 40;

/* -------- DOM refs --------- */
const resultsEl = document.getElementById("results");
const playlistEl = document.getElementById("playlist");
const searchInput = document.getElementById("searchInput");
const playerThumb = document.getElementById("playerThumb");
const playerTitle = document.getElementById("playerTitle");
const playerAuthor = document.getElementById("playerAuthor");
const playBtn = document.getElementById("playBtn");
const prevBtn = document.getElementById("prevBtn");
const nextBtn = document.getElementById("nextBtn");
const progressFill = document.getElementById("progressFill");
const playerBar = document.getElementById("playerBar");

/* -------- state ---------- */
let ytPlayerMain = null;
let previewPlayer = null;
let previewHost = null;
let searchResults = [];
let playlist = [];
let currentIndex = -1;
let isPlaying = false;
let progressTimer = null;

/* ---------- UTILS ---------- */
function formatTime(seconds) {
  seconds = Math.max(0, Math.floor(seconds || 0));
  const m = Math.floor(seconds / 60);
  const s = seconds % 60;
  return `${m}:${s.toString().padStart(2, "0")}`;
}

/* ---------- YT IFRAME API READY ---------- */
function onYouTubeIframeAPIReady() {
  const host = document.createElement("div");
  host.id = "yt-main-host";
  host.style.width = "0";
  host.style.height = "0";
  host.style.position = "absolute";
  host.style.left = "-9999px";
  host.style.pointerEvents = "none"; // ← tıklama engellendi
  document.body.appendChild(host);

  ytPlayerMain = new YT.Player(host, {
    height: "0",
    width: "0",
    videoId: "",
    playerVars: {
      autoplay: 0,
      controls: 0,
      modestbranding: 1,
      rel: 0,
      playsinline: 1,
      disablekb: 1,
      fs: 0,
      origin: window.location.origin // postMessage hatası fix
    },
    events: {
      onStateChange: onMainStateChange,
      onReady: () => {}
    }
  });
}

/* ---------- MAIN PLAYER STATE HANDLER ---------- */
function onMainStateChange(e) {
  if (!ytPlayerMain) return;
  const state = e.data;
  if (state === YT.PlayerState.PLAYING) {
    isPlaying = true;
    playBtn.innerText = "⏸";
    startProgressTicker();
  } else if (state === YT.PlayerState.PAUSED || state === YT.PlayerState.BUFFERING) {
    isPlaying = false;
    playBtn.innerText = "▶";
    stopProgressTicker();
  } else if (state === YT.PlayerState.ENDED) {
    nextTrack();
  }
}

/* ---------- PROGRESS TICKER ---------- */
function startProgressTicker() {
  stopProgressTicker();
  progressTimer = setInterval(() => {
    try {
      const cur = ytPlayerMain.getCurrentTime();
      const dur = ytPlayerMain.getDuration() || 0;
      const pct = dur ? Math.min(100, (cur / dur) * 100) : 0;
      progressFill.style.width = pct + "%";
    } catch (e) {}
  }, 350);
}

function stopProgressTicker() {
  if (progressTimer) {
    clearInterval(progressTimer);
    progressTimer = null;
  }
}

/* ---------- YOUTUBE SEARCH ---------- */
async function ytSearch(q) {
  if (!q) return [];
  const endpoint = "https://www.googleapis.com/youtube/v3/search";
  const params = new URLSearchParams({
    part: "snippet",
    q,
    type: "video",
    maxResults: String(MAX_RESULTS),
    key: API_KEY,
    videoCategoryId: "10"
  });

  try {
    const res = await fetch(`${endpoint}?${params.toString()}`);
    if (!res.ok) return [];
    const j = await res.json();
    return j.items || [];
  } catch (err) {
    return [];
  }
}

/* ---------- RENDER RESULTS ---------- */
function renderResults(items) {
  searchResults = items;
  resultsEl.innerHTML = "";

  items.forEach((it, idx) => {
    const vid = it.id.videoId;
    const title = it.snippet.title;
    const ch = it.snippet.channelTitle;
    const thumb =
      it.snippet.thumbnails?.medium?.url ||
      it.snippet.thumbnails?.default?.url ||
      "";

    const card = document.createElement("div");
    card.className = "result-item";
    card.dataset.index = idx;
    card.style.position = "relative";
    card.style.overflow = "hidden"; // siyah katman fix

    card.innerHTML = `
      <img src="${thumb}" alt="">
      <div style="flex:1">
        <div class="result-title">${title}</div>
        <div class="channel">${ch}</div>
      </div>
      <button class="plusBtn" style="background:#1DB954;border:none;padding:8px;border-radius:8px;margin-left:8px;cursor:pointer">+</button>
    `;

    // Hover Preview
    card.addEventListener("mouseenter", () => startPreview(vid, card));
    card.addEventListener("mouseleave", stopPreview);

    // Play if clicked
    card.addEventListener("click", (e) => {
      if (e.target.closest(".plusBtn")) return;
      playFromResults(idx);
    });

    // Playlist add
    const plus = card.querySelector(".plusBtn");
    plus.addEventListener("click", (ev) => {
      ev.stopPropagation();
      addToPlaylist({ videoId: vid, title, thumb, channel: ch });
    });

    resultsEl.appendChild(card);
  });
}

/* ---------- PREVIEW ---------- */
function startPreview(videoId, cardElement) {
  stopPreview();
  previewHost = document.createElement("div");
  previewHost.style.position = "absolute";
  previewHost.style.left = "0";
  previewHost.style.top = "0";
  previewHost.style.width = "100%";
  previewHost.style.height = "100%";
  previewHost.style.borderRadius = "8px";
  previewHost.style.overflow = "hidden";
  previewHost.style.zIndex = "5";
  previewHost.style.pointerEvents = "none"; // tıklama engellendi

  const previewDiv = document.createElement("div");
  previewDiv.style.width = "100%";
  previewDiv.style.height = "100%";
  previewDiv.id = "preview-" + Date.now();
  previewHost.appendChild(previewDiv);
  cardElement.appendChild(previewHost);

  const start = Math.floor(Math.random() * (PREVIEW_MAX_START - PREVIEW_MIN_START)) + PREVIEW_MIN_START;
  const end = start + PREVIEW_SECONDS;

  previewPlayer = new YT.Player(previewDiv, {
    height: "100%",
    width: "100%",
    videoId: videoId,
    playerVars: {
      autoplay: 1,
      controls: 0,
      start,
      end,
      mute: 1,
      modestbranding: 1,
      playsinline: 1,
      rel: 0,
      origin: window.location.origin
    },
    events: {
      onReady: (e) => e.target.playVideo()
    }
  });
}

function stopPreview() {
  try {
    if (previewPlayer) previewPlayer.destroy();
  } catch (e) {}

  previewPlayer = null;

  try {
    if (previewHost && previewHost.parentNode)
      previewHost.parentNode.removeChild(previewHost);
  } catch (e) {}

  previewHost = null;
}

/* ---------- PLAYLIST ---------- */
function addToPlaylist(item) {
  playlist.push(item);
  renderPlaylist();
}

function renderPlaylist() {
  playlistEl.innerHTML = "";
  playlist.forEach((p, i) => {
    const el = document.createElement("div");
    el.className = "playlistItem";
    el.innerHTML = `<img src="${p.thumb}"><div class="playlistMeta">${p.title}</div>`;
    el.addEventListener("click", () => playFromPlaylist(i));
    playlistEl.appendChild(el);
  });
}

/* ---------- PLAY ---------- */
function playFromResults(idx) {
  const it = searchResults[idx];
  if (!it) return;

  const obj = {
    videoId: it.id.videoId,
    title: it.snippet.title,
    thumb:
      it.snippet.thumbnails?.medium?.url ||
      it.snippet.thumbnails?.default?.url ||
      "",
    channel: it.snippet.channelTitle
  };

  currentIndex = idx;
  startMainPlayback(obj);
}

function playFromPlaylist(idx) {
  const p = playlist[idx];
  if (!p) return;

  currentIndex = -1;
  startMainPlayback(p);
}

function startMainPlayback(item) {
  playerBar.style.display = "flex";

  playerThumb.src = item.thumb || "";
  playerTitle.innerText = item.title || "";
  playerAuthor.innerText = item.channel || "";

  try {
    ytPlayerMain.loadVideoById({ videoId: item.videoId, startSeconds: 0 });
    ytPlayerMain.playVideo();
  } catch (err) {
    try {
      ytPlayerMain.loadVideoById(item.videoId);
      ytPlayerMain.playVideo();
    } catch (e) {}
  }
}

/* ---------- CONTROLS ---------- */
playBtn.addEventListener("click", () => {
  const st = ytPlayerMain.getPlayerState();
  if (st === YT.PlayerState.PLAYING) ytPlayerMain.pauseVideo();
  else ytPlayerMain.playVideo();
});

nextBtn.addEventListener("click", nextTrack);
prevBtn.addEventListener("click", prevTrack);

function nextTrack() {
  if (playlist.length > 0) {
    if (typeof playlistPlayIndex === "undefined") playlistPlayIndex = 0;
    playlistPlayIndex = (playlistPlayIndex + 1) % playlist.length;
    playFromPlaylist(playlistPlayIndex);
  } else {
    if (currentIndex < searchResults.length - 1)
      playFromResults(currentIndex + 1);
  }
}

function prevTrack() {
  if (playlist.length > 0) {
    if (typeof playlistPlayIndex === "undefined") playlistPlayIndex = 0;
    playlistPlayIndex = (playlistPlayIndex - 1 + playlist.length) % playlist.length;
    playFromPlaylist(playlistPlayIndex);
  } else {
    if (currentIndex > 0) playFromResults(currentIndex - 1);
  }
}

/* ---------- SEARCH ---------- */
let suggestionTimeout = null;
searchInput.addEventListener("input", () => {
  const q = searchInput.value.trim();
  if (suggestionTimeout) clearTimeout(suggestionTimeout);

  suggestionTimeout = setTimeout(async () => {
    if (!q) {
      resultsEl.innerHTML = "";
      return;
    }

    const data = await ytSearch(q);
    renderResults(data.slice(0, 8));
  }, 260);
});
